/**
 * ptAnywhere - User friendly interface to use PT Anywhere.
 * @version v2.0.1
 * @link http://pt-anywhere.kmi.open.ac.uk
 */
angular.module("ptAnywhere",["ngRoute"]).config(["$injector","$provide",function(e,t){var n={baseUrl:"",apiUrl:""};for(var o in n)try{e.get(o)}catch(i){console.log('Setting default value for non existing "baseUrl" constant: "'+n[o]+'"'),t.constant(o,n[o])}}]).config(["$routeProvider","baseUrl",function(e,t){e.when("/",{template:"",controller:"SessionCreatorController"}).when("/not-found",{templateUrl:t+"/html/not-found.html"}).when("/loading/:id",{templateUrl:t+"/html/loading.html"}).when("/s/:id",{templateUrl:t+"/html/main-widget.html"}).otherwise("/")}]),angular.module("ptAnywhere").controller("SessionCreatorController",["$location","PTAnywhereAPIService","fileToOpen",function(e,t,n){t.createSession(n,null).then(function(t){e.path("/loading/"+t)})}]).controller("SessionLoadingController",["$location","$routeParams","PTAnywhereAPIService","NetworkMapData","baseUrl","locale_en",function(e,t,n,o,i,r){var a=this;a.baseUrl=i,a.loading=r.network.loading,a.message="",n.startSession(t.id),n.getNetwork(function(e){a.message=e}).then(function(n){o.load(n),e.path("/s/"+t.id)},function(t){e.path("/not-found")})}]).controller("WidgetController",["$location","$routeParams","baseUrl","NetworkMapData",function(e,t,n,o){var i=this;o.isLoaded()?i.iconsPath=n+"/images/":e.path("/loading/"+t.id),i.openConsole=function(e){var t="console?endpoint="+e;i.openCmdModal(t)},i.onAddDevice=function(e,t){},i.onAddLink=function(e,t){i.openAddLinkModal(e,t,function(n,i,r){o.connect(e,t,n.id,n.url,i,r)})},i.onEditDevice=function(e){},i.onDeleteDevice=function(e){},i.onDeleteLink=function(e){}}]),angular.module("ptAnywhere").factory("PTAnywhereAPIService",["$http","apiUrl","HttpRetry",function(e,t,n){var o="";return{createSession:function(n,i){var r={fileUrl:n};return null!==i&&(r.sameUserAsInSession=i),e.post(t+"/sessions",r,{timeout:1e4}).then(function(e){o=e.data;var t=e.data.split("/"),n=t[t.length-1];return n})},startSession:function(e){o=t+"/sessions/"+e},getNetwork:function(t){var i=function(e){return e.data};return n.setSuccess(i),n.setExplainer(t),e.get(o+"/network",{timeout:2e3}).then(i,n.responseError)},getAvailablePorts:function(t){return e.get(t.url+"ports?free=true").then(function(e){return e.data})}}}]).factory("HttpRetry",["$http","$q","$timeout","$location","locale_en",function(e,t,n,o,i){function r(t,o){return n(function(){return e(t).then(s,l)},o)}function a(e){var t;switch(e){case 503:t=i.network.errorUnavailable;break;case 0:t=i.network.errorTimeout;break;default:t=i.network.errorUnknown}return t+". "+i.network.attempt+" "+c+"/"+d+"."}function l(e){if((0===e.status||503===e.status)&&c<d){var n=0===e.status?0:2e3;return c++,u(a(e.status)),r(e.config,n)}return t.reject(e)}var c=0,d=5,s=null,u=null;return{responseError:l,setSuccess:function(e){s=e},setExplainer:function(e){u=e}}}]).factory("HttpErrorsInterceptor",["$q","$location",function(e,t){return{responseError:function(n){return 404!==n.status&&410!==n.status||t.path("/not-found"),e.reject(n)}}}]),angular.module("ptAnywhere").directive("cmdDialog",["locale_en","baseUrl",function(e,t){return{restrict:"C",scope:{open:"=",backdrop:"@"},templateUrl:t+"/html/cmd-dialog.html",link:function(t,n,o){var i=$(n.find("div")[0]),r={backdrop:"backdrop"in t&&"true"===t.backdrop};t.title=e.commandLineDialog.title,t.open=function(e){var t=$("iframe.terminal",i);t.attr("src",e),t.on("load",function(){console.log("LOADED"),i.modal(r),i.modal("show")})}}}}]),angular.module("ptAnywhere").directive("networkMap",["locale_en","baseUrl","NetworkMapData",function(e,t,n){function o(){var e=u.getSelection();return 1!==e.nodes.length?(console.log("Only one device is supposed to be selected. Instead "+e.nodes.length+" are selected."),null):n.getNode(e.nodes[0])}function i(e){return 0===e.nodes.length&&1===e.edges.length}function r(e){return e.nodes.length>0}function a(e){return e.label.indexOf("\n")!==-1}function l(e){var t=n.getNode(e.from),o=n.getNode(e.to);a(t)||(t.label=t.label+"\n("+e.fromLabel+")",n.updateNode(t)),a(o)||(o.label=o.label+"\n("+e.toLabel+")",n.updateNode(o))}function c(e){var t=n.getNode(e.from),o=n.getNode(e.to);a(t)&&(t.label=t.label.split("\n")[0],n.updateNode(t)),a(o)&&(o.label=o.label.split("\n")[0],n.updateNode(o))}function d(e){for(var t=0;t<e.edges.length;t++)c(n.getEdge(e.edges[t]))}function s(e){var t=function(e,t){},o=t,i=t,r=t,a=t,l=t;return"onAddDevice"in e&&(o=function(t,n){e.onAddDevice(t.x,t.y)}),"onAddLink"in e&&(i=function(t,o){var i=n.getNode(t.from),r=n.getNode(t.to);e.onAddLink({fromDevice:i,toDevice:r})}),"onEditDevice"in e&&(r=function(t,o){e.onEditDevice(n.getNode(t.id)),o(t)}),"onDeleteDevice"in e&&(a=function(t,o){e.onDeleteDevice(n.getNode(t.nodes[0])),o(t)}),"onDeleteLink"in e&&(l=function(t,o){var i=n.getEdge(t.edges[0]);c(i),e.onDeleteLink(i),o(t)}),{initiallyActive:!0,addNode:o,addEdge:i,editNode:r,editEdge:!1,deleteNode:a,deleteEdge:l}}var u;return{restrict:"C",scope:{iconsSrc:"@",onDoubleClick:"&",onAddDevice:"&",onAddLink:"&",onEditDevice:"&",onDeleteDevice:"&",onDeleteLink:"&"},template:'<div class="map"></div>',link:function(t,a,c){var f={nodes:n.getNodes(),edges:n.getEdges()},g={nodes:{physics:!1,font:"14px verdana black"},edges:{width:3,selectionWidth:1.4,color:{color:"#606060",highlight:"#000000",hover:"#000000"}},groups:{cloudDevice:{shape:"image",image:t.iconsSrc+"cloud.png",size:50},routerDevice:{shape:"image",image:t.iconsSrc+"router_cropped.png",size:45},switchDevice:{shape:"image",image:t.iconsSrc+"switch_cropped.png",size:35},pcDevice:{shape:"image",image:t.iconsSrc+"pc_cropped.png",size:45}},manipulation:s(t),locale:"ptAnywhere",locales:{ptAnywhere:e.manipulationMenu}},p=a.find("div")[0];u=new vis.Network(p,f,g),u.on("select",function(e){if(i(e)){var t=edges.get(e.edges[0]);l(t)}else r(e)&&d(e)}),u.on("deselectEdge",function(e){i(e.previousSelection)&&d(e.previousSelection)}),"onDoubleClick"in t&&u.on("doubleClick",function(){var e=o();null!==e&&t.onDoubleClick({endpoint:e.consoleEndpoint})})}}}]),angular.module("ptAnywhere").factory("NetworkMapData",[function(){var e=!1,t=new vis.DataSet,n=new vis.DataSet;return{load:function(o){e=!0,null!==o.devices&&(t.clear(),t.add(o.devices)),null!==o.edges&&(n.clear(),n.add(o.edges))},isLoaded:function(){return e},getNode:function(e){return t.get(e)},updateNode:function(e){t.update(e)},getNodes:function(){return t},getEdge:function(e){return n.get(e)},getEdges:function(){return n},connect:function(e,t,o,i,r,a){var l;l="string"==typeof e&&"string"==typeof t?{from:getByName(e).id,to:getByName(t).id}:{from:e.id,to:t.id},void 0!==o&&(l.id=o),void 0!==i&&(l.url=i),void 0!==r&&(l.fromLabel=r),void 0!==a&&(l.toLabel=a),n.add(l)}}}]),angular.module("ptAnywhere").controller("LinkController",["$scope","baseUrl","PTAnywhereAPIService","NetworkMapData",function(e,t,n,o){var i=this;i.fromDevice=null,i.toDevice=null,i.fromInterfaces=null,i.toInterfaces=null,i.load=function(){if(null!==i.fromDevice&&null!==i.toDevice){var t=[n.getAvailablePorts(i.fromDevice),n.getAvailablePorts(i.toDevice)];Promise.all(t).then(function(t){i.fromInterfaces=t[0],i.toInterfaces=t[1],e.$$phase||e.$apply()},function(){console.error("Not loaded!")})}},i.submit=function(){console.log("Connecting...",i.selected.fromIface,i.selected.toIface)}}]),angular.module("ptAnywhere").directive("linkDialog",["locale_en","baseUrl",function(e,t){function n(e,t,n){e.fromDevice=t,e.toDevice=n,e.fromDeviceName=null===t?"Device 1":t.label,e.toDeviceName=null===n?"Device 2":n.label}function o(o){o.locale=e,o.modal={id:"linkDialog",title:e.linkDialog.title,bodyTemplate:t+"/html/link-dialog-body.html",hasSubmit:!1},o.show={loading:!0,loaded:!1,error:!1},o.errorMsg="",o.selected={fromIface:null,toIface:null},n(o,null,null)}function i(e){e.show.loading=!1,e.show.loaded=!0,e.show.error=!1,e.modal.hasSubmit=!0}function r(e){e.show.loading=!1,e.show.loaded=!1,e.show.error=!0,e.modal.hasSubmit=!1}return{restrict:"C",scope:{open:"=",backdrop:"@",init:"&",fromDevice:"=",toDevice:"=",fromIfaces:"=",toIfaces:"=",selected:"=",onSubmit:"&"},templateUrl:t+"/html/default-dialog.html",link:function(e,t,a){o(e);var l=$(t.find("div")[0]),c={backdrop:"backdrop"in e&&"true"===e.backdrop};e.open=function(t,o){n(e,t,o),e.$$phase||e.$apply(),i(e),e.init(),l.modal(c),l.modal("show")},e.$watch("fromIfaces",function(t,n){null!==e.fromIfaces&&(e.selected.fromIface=e.fromIfaces[0])}),e.$watch("toIfaces",function(t,n){null!==e.toIfaces&&(e.selected.toIface=e.toIfaces[0])}),e.$watchGroup(["fromIfaces","toIfaces"],function(t,n){for(var o in t)null!==t[o]&&0===t[o].length&&r(e)})}}}]),angular.module("ptAnywhere").value("locale_en",{loading:"Loading...",loadingInfo:"Loading info...",name:"Name",manipulationMenu:{edit:"Edit",del:"Delete selected",back:"Back",addNode:"Add Device",addEdge:"Connect Devices",editNode:"Edit Device",addDescription:"Click in an empty space to place a new device.",edgeDescription:"Click on a node and drag the edge to another element to connect them.",editEdge:"Edit Edge",editEdgeDescription:"Click on the control points and drag them to a node to connect to it.",createEdgeError:"Cannot link edges to a cluster.",deleteClusterError:"Clusters cannot be deleted.",editClusterError:"Clusters cannot be edited."},session:{creating:{title:"Creating new session...",content:""},unavailable:{title:"Unavailable PT instances",content:"<p>Sorry, there are <b>no Packet Tracer instances available</b> right now to initiate a session.</p><p>Please, wait a little bit and <b>try again</b>.</p>"}},network:{loading:"Loading network...",attempt:"Attempt",errorUnavailable:"Instance not yet available",errorTimeout:"Timeout",errorUnknown:"Unknown error",notLoaded:{title:"Topology not found",content:'<p>The topology could not be loaded probably because the session does not exist (e.g., if it has expired).</p><p><a href="?session">Click here</a> to initiate a new one.</p>'}},commandLineDialog:{title:"Command line"},linkDialog:{title:"Connect two devices",select:"Please select which ports to connect...",error:"Sorry, something went wrong during the link creation."},creationDialog:{title:"Create new device",type:"Device type"},creationMenu:{legend:"To create a new device, drag it to the network map"},modificationDialog:{title:"Modify device",globalSettings:"Global Settings",interfaces:"Interfaces",defaultGW:"Default gateway",ipAddress:"IP address",subnetMask:"Subnet mask",noSettings:"No settings can be specified for this type of interface."}});