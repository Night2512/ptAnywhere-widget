/**
 * ptAnywhere - User friendly interface to use PT Anywhere.
 * @version v2.0.1
 * @link http://pt-anywhere.kmi.open.ac.uk
 */
angular.module("ptAnywhere",["ngRoute","ui.bootstrap"]).config(["$injector","$provide",function(e,t){var n={baseUrl:"",apiUrl:""};for(var o in n)try{e.get(o)}catch(i){console.log('Setting default value for non existing "baseUrl" constant: "'+n[o]+'"'),t.constant(o,n[o])}}]).config(["$routeProvider","baseUrl",function(e,t){e.when("/",{template:"",controller:"SessionCreatorController"}).when("/not-found",{templateUrl:t+"/html/not-found.html"}).when("/loading/:id",{templateUrl:t+"/html/loading.html"}).when("/s/:id",{templateUrl:t+"/html/main-widget.html"}).otherwise("/")}]),angular.module("ptAnywhere").controller("SessionCreatorController",["$location","PTAnywhereAPIService","fileToOpen",function(e,t,n){t.createSession(n,null).then(function(t){e.path("/loading/"+t)})}]).controller("SessionLoadingController",["$location","$routeParams","PTAnywhereAPIService","NetworkMapData","baseUrl","locale_en",function(e,t,n,o,i,r){var a=this;a.baseUrl=i,a.loading=r.network.loading,a.message="",n.startSession(t.id),n.getNetwork(function(e){a.message=e}).then(function(n){o.load(n),e.path("/s/"+t.id)},function(t){e.path("/not-found")})}]).controller("WidgetController",["$q","$log","$location","$routeParams","$uibModal","baseUrl","NetworkMapData","PTAnywhereAPIService",function(e,t,n,o,i,r,a,l){var c=this;a.isLoaded()?(c.iconsPath=r+"/images/",c.openConsole=function(e){var t="console?endpoint="+e;c.openCmdModal(t)},c.onAddDevice=function(e,t){c.openAddDeviceModal(e,t)},c.onAddLink=function(e,t){c.openAddLinkModal(e,t)},c.onEditDevice=function(e){var t=i.open({animation:!1,templateUrl:r+"/html/default-dialog2.html",controller:"UpdateController",resolve:{device:function(){return e}}});t.result.then(function(e){null!==e&&a.updateNode(e)})},c.onDeleteDevice=function(n){return e(function(e,o){l.removeDevice(n).then(function(){e()},function(e){t.error("Device removal.",e),o()})})},c.onDeleteLink=function(n){return e(function(e,o){l.removeLink(n).then(function(){e()},function(){t.error("Something went wrong in the link removal."),o()})})}):n.path("/loading/"+o.id)}]),angular.module("ptAnywhere").factory("PTAnywhereAPIService",["$http","apiUrl","HttpRetry",function(e,t,n){var o="",i={timeout:2e3};return{createSession:function(n,i){var r={fileUrl:n};return null!==i&&(r.sameUserAsInSession=i),e.post(t+"/sessions",r,{timeout:1e4}).then(function(e){o=e.data;var t=e.data.split("/"),n=t[t.length-1];return n})},startSession:function(e){o=t+"/sessions/"+e},getNetwork:function(t){var r=function(e){return e.data};return n.setSuccess(r),n.setExplainer(t),e.get(o+"/network",i).then(r,n.responseError)},addDevice:function(t){return e.post(o+"/devices",t,i).then(function(e){return e.data})},removeDevice:function(t){return e["delete"](t.url,i)},modifyDevice:function(t,n,o){var r={label:n};return""!==o&&(r.defaultGateway=o),e.put(t.url,r,i).then(function(e){var t=e.data;return t.defaultGateway=o,t})},modifyPort:function(t,n,o){var r={portIpAddress:n,portSubnetMask:o};return e.put(t,r,i).then(function(e){return e.data})},getAllPorts:function(t){return e.get(t.url+"ports",i).then(function(e){return e.data})},getAvailablePorts:function(t){return e.get(t.url+"ports?free=true",i).then(function(e){return e.data})},createLink:function(t,n){var o={toPort:n};return e.post(t+"link",o,i).then(function(e){return e.data})},removeLink:function(t){return e.get(t.url,i).then(function(t){return e["delete"](t.data.endpoints[0]+"link")})}}}]).factory("HttpRetry",["$http","$q","$timeout","$location","locale_en",function(e,t,n,o,i){function r(t,o){return n(function(){return e(t).then(u,l)},o)}function a(e){var t;switch(e){case 503:t=i.network.errorUnavailable;break;case 0:t=i.network.errorTimeout;break;default:t=i.network.errorUnknown}return t+". "+i.network.attempt+" "+c+"/"+d+"."}function l(e){if((0===e.status||503===e.status)&&c<d){var n=0===e.status?0:2e3;return c++,s(a(e.status)),r(e.config,n)}return t.reject(e)}var c=0,d=5,u=null,s=null;return{responseError:l,setSuccess:function(e){u=e},setExplainer:function(e){s=e}}}]).factory("HttpErrorsInterceptor",["$q","$location",function(e,t){return{responseError:function(n){return 404!==n.status&&410!==n.status||t.path("/not-found"),e.reject(n)}}}]),angular.module("ptAnywhere").controller("UpdateController",["$log","$scope","$uibModalInstance","locale_en","baseUrl","PTAnywhereAPIService","NetworkMapData","device",function(e,t,n,o,i,r,a,l){var c=this;t.submitError=null,t.interfaces=null,t["interface"]={selected:null,ipAddr:null,subnet:null},t.locale=o,t.modal={id:"modification-dialog",title:o.modificationDialog.title,bodyTemplate:i+"/html/update-dialog-body.html",hasSubmit:!0},t.device={name:l.label,defaultGateway:"defaultGateway"in l?l.defaultGateway:null},t.$watch("interfaces",function(e,n){null!==e&&(t["interface"].selected=e[0])}),t.$watch("interface.selected",function(e,n){e&&"portIpAddress"in e&&"portSubnetMask"in e?(t["interface"].ipAddr=e.portIpAddress,t["interface"].subnet=e.portSubnetMask):(t["interface"].ipAddr=null,t["interface"].subnet=null)}),c._haveGlobalSettingsChanged=function(){return t.device.name!=l.label||"defaultGateway"in l&&t.device.defaultGateway!=l.defaultGateway},c._hasInterfaceChanged=function(){return null!==t["interface"].ipAddr&&null!==t["interface"].subnet&&(t["interface"].ipAddr!=t["interface"].selected.portIpAddress||t["interface"].subnet!=t["interface"].selected.portSubnetMask)},t.submit=function(){var o;o=c._haveGlobalSettingsChanged()?r.modifyDevice(l,t.device.name,t.device.defaultGateway).then(function(e){return e},function(e){return t.submitError="Global settings could not be modified.",e}):Promise.resolve(null),c._hasInterfaceChanged()&&(o=o.then(function(e){return r.modifyPort(t["interface"].selected.url,t["interface"].ipAddr,t["interface"].subnet).then(function(t){return e},function(e){return t.submitError="Interface details could not be modified.",e})})),o.then(function(e){n.close(e)},function(t){e.error("Update(s) could not be performed.",t)})},t.close=function(){n.dismiss("cancel")},r.getAllPorts(l).then(function(e){t.interfaces=e,t.$$phase||t.$apply()},function(){t.submitError="Ports for the device "+l.id+" could not be loaded. Possible timeout."})}]),angular.module("ptAnywhere").controller("CreationController",["$scope","PTAnywhereAPIService","NetworkMapData",function(e,t,n){var o=this;o.allowedTypes=[{value:"cloud",label:"Cloud"},{value:"router",label:"Router"},{value:"switch",label:"Switch"},{value:"pc",label:"PC"}],o.submit=function(){var e={label:o.device.name,group:o.device.type.value,x:o.device.x,y:o.device.y};o.submitError=null,t.addDevice(e).then(function(e){n.addNode(e),o.close()},function(e){var t=e.status===-1?"timeout":e.statusText;o.submitError="Device could not be created ("+t+").",console.error("Device creation",e)})},e.$$phase||e.$apply()}]),angular.module("ptAnywhere").directive("creationDialog",["locale_en","baseUrl",function(e,t){function n(n){n.locale=e,n.modal={id:"creationDialog",title:e.creationDialog.title,bodyTemplate:t+"/html/creation-dialog-body.html",hasSubmit:!0},n.submitError=null,n.newDevice={name:"",type:null,x:0,y:0}}return{templateUrl:t+"/html/default-dialog.html",restrict:"C",scope:{open:"=",close:"=",backdrop:"@",deviceTypes:"=",newDevice:"=",onSubmit:"&",submitError:"="},link:function(e,t,o){n(e);var i=$(t.find("div")[0]),r={backdrop:"backdrop"in o&&"true"===e.backdrop};e.open=function(t,n){e.newDevice.name="",e.newDevice.type=e.deviceTypes[0],e.newDevice.x=t,e.newDevice.y=n,e.$$phase||e.$apply(),i.modal(r),i.modal("show")},e.close=function(){i.modal("hide")}}}}]),angular.module("ptAnywhere").directive("cmdDialog",["locale_en","baseUrl",function(e,t){return{restrict:"C",scope:{open:"=",backdrop:"@"},templateUrl:t+"/html/cmd-dialog.html",link:function(t,n,o){var i=$(n.find("div")[0]),r={backdrop:"backdrop"in t&&"true"===t.backdrop};t.title=e.commandLineDialog.title,t.open=function(e){var t=$("iframe.terminal",i);t.attr("src",e),t.on("load",function(){console.log("LOADED"),i.modal(r),i.modal("show")})}}}}]),angular.module("ptAnywhere").directive("networkMap",["locale_en","baseUrl","NetworkMapData",function(e,t,n){function o(t,o){var i={nodes:n.getNodes(),edges:n.getEdges()},r={nodes:{physics:!1,font:"14px verdana black"},edges:{width:3,selectionWidth:1.4,color:{color:"#606060",highlight:"#000000",hover:"#000000"}},groups:{cloudDevice:{shape:"image",image:t.iconsSrc+"cloud.png",size:50},routerDevice:{shape:"image",image:t.iconsSrc+"router_cropped.png",size:45},switchDevice:{shape:"image",image:t.iconsSrc+"switch_cropped.png",size:35},pcDevice:{shape:"image",image:t.iconsSrc+"pc_cropped.png",size:45}},manipulation:s(t),locale:"ptAnywhere",locales:{ptAnywhere:e.manipulationMenu}},a=o.find("div")[0];return new vis.Network(a,i,r)}function i(){var e=f.getSelection();return 1!==e.nodes.length?(console.log("Only one device is supposed to be selected. Instead "+e.nodes.length+" are selected."),null):n.getNode(e.nodes[0])}function r(e){return 0===e.nodes.length&&1===e.edges.length}function a(e){return e.nodes.length>0}function l(e){return e.label.indexOf("\n")!==-1}function c(e){var t=n.getNode(e.from),o=n.getNode(e.to);l(t)||(t.label=t.label+"\n("+e.fromLabel+")",n.updateNode(t)),l(o)||(o.label=o.label+"\n("+e.toLabel+")",n.updateNode(o))}function d(e){var t=n.getNode(e.from),o=n.getNode(e.to);l(t)&&(t.label=t.label.split("\n")[0],n.updateNode(t)),l(o)&&(o.label=o.label.split("\n")[0],n.updateNode(o))}function u(e){for(var t=0;t<e.edges.length;t++)d(n.getEdge(e.edges[t]))}function s(e){var t=function(e,t){},o=t,i=t,r=t,a=t,l=t;return"onAddDevice"in e&&(o=function(t,n){e.onAddDevice({x:t.x,y:t.y})}),"onAddLink"in e&&(i=function(t,o){var i=n.getNode(t.from),r=n.getNode(t.to);e.onAddLink({fromDevice:i,toDevice:r})}),"onEditDevice"in e&&(r=function(t,o){e.onEditDevice({device:n.getNode(t.id)}),o(t)}),"onDeleteDevice"in e&&(a=function(t,o){e.onDeleteDevice({device:n.getNode(t.nodes[0])}).then(function(){o(t)})}),"onDeleteLink"in e&&(l=function(t,o){var i=n.getEdge(t.edges[0]);d(i),e.onDeleteLink({link:i}).then(function(){o(t)})}),{initiallyActive:!0,addNode:o,addEdge:i,editNode:r,editEdge:!1,deleteNode:a,deleteEdge:l}}var f;return{restrict:"C",scope:{iconsSrc:"@",onDoubleClick:"&",onAddDevice:"&",onAddLink:"&",onEditDevice:"&",onDeleteDevice:"&",onDeleteLink:"&"},template:'<div class="map"></div>',link:function(e,t,l){"iconsSrc"in l&&""!==e.iconsSrc&&(f=o(e,t),e.$on("$destroy",function(){f.destroy()}),f.on("select",function(e){if(r(e)){var t=n.getEdge(e.edges[0]);c(t)}else a(e)&&u(e)}),f.on("deselectEdge",function(e){r(e.previousSelection)&&u(e.previousSelection)}),"onDoubleClick"in e&&f.on("doubleClick",function(){var t=i();null!==t&&e.onDoubleClick({endpoint:t.consoleEndpoint})}))}}}]),angular.module("ptAnywhere").factory("NetworkMapData",[function(){var e=!1,t=new vis.DataSet,n=new vis.DataSet;return{load:function(o){e=!0,null!==o.devices&&(t.clear(),t.add(o.devices)),null!==o.edges&&(n.clear(),n.add(o.edges))},isLoaded:function(){return e},getNode:function(e){return t.get(e)},updateNode:function(e){t.update(e)},addNode:function(e){return t.add(e)},getNodes:function(){return t},getEdge:function(e){return n.get(e)},getEdges:function(){return n},connect:function(e,t,o,i,r,a){var l;l="string"==typeof e&&"string"==typeof t?{from:getByName(e).id,to:getByName(t).id}:{from:e.id,to:t.id},void 0!==o&&(l.id=o),void 0!==i&&(l.url=i),void 0!==r&&(l.fromLabel=r),void 0!==a&&(l.toLabel=a),n.add(l)}}}]),angular.module("ptAnywhere").value("locale_en",{loading:"Loading...",loadingInfo:"Loading info...",name:"Name",manipulationMenu:{edit:"Edit",del:"Delete selected",back:"Back",addNode:"Add Device",addEdge:"Connect Devices",editNode:"Edit Device",addDescription:"Click in an empty space to place a new device.",edgeDescription:"Click on a node and drag the edge to another element to connect them.",editEdge:"Edit Edge",editEdgeDescription:"Click on the control points and drag them to a node to connect to it.",createEdgeError:"Cannot link edges to a cluster.",deleteClusterError:"Clusters cannot be deleted.",editClusterError:"Clusters cannot be edited."},session:{creating:{title:"Creating new session...",content:""},unavailable:{title:"Unavailable PT instances",content:"<p>Sorry, there are <b>no Packet Tracer instances available</b> right now to initiate a session.</p><p>Please, wait a little bit and <b>try again</b>.</p>"}},network:{loading:"Loading network...",attempt:"Attempt",errorUnavailable:"Instance not yet available",errorTimeout:"Timeout",errorUnknown:"Unknown error",notLoaded:{title:"Topology not found",content:'<p>The topology could not be loaded probably because the session does not exist (e.g., if it has expired).</p><p><a href="?session">Click here</a> to initiate a new one.</p>'}},commandLineDialog:{title:"Command line"},linkDialog:{title:"Connect two devices",select:"Please select which ports to connect...",error:"Sorry, something went wrong during the link creation."},creationDialog:{title:"Create new device",type:"Device type"},creationMenu:{legend:"To create a new device, drag it to the network map"},modificationDialog:{title:"Modify device",globalSettings:"Global Settings",interfaces:"Interfaces",defaultGW:"Default gateway",ipAddress:"IP address",subnetMask:"Subnet mask",noSettings:"No settings can be specified for this type of interface."}}),angular.module("ptAnywhere").controller("LinkController",["$scope","PTAnywhereAPIService","NetworkMapData",function(e,t,n){var o=this;o.fromDevice=null,o.toDevice=null,o.fromInterfaces=null,o.toInterfaces=null,o.load=function(){if(null!==o.fromDevice&&null!==o.toDevice){var n=[t.getAvailablePorts(o.fromDevice),t.getAvailablePorts(o.toDevice)];Promise.all(n).then(function(t){o.fromInterfaces=t[0],o.toInterfaces=t[1],e.$$phase||e.$apply()},function(){console.error("Not loaded!")})}},o.submit=function(){var e=o.selected.fromIface,i=o.selected.toIface;console.log("Connecting...",e,i),o.submitError=null,t.createLink(e.url,i.url).then(function(t){n.connect(o.fromDevice,o.toDevice,t.id,t.url,e.portName,i.portName)},function(e){o.submitError="Link could not be created ("+e.statusText+").",console.error("Link creation",e)})}}]),angular.module("ptAnywhere").directive("linkDialog",["locale_en","baseUrl",function(e,t){function n(e,t,n){e.fromDevice=t,e.toDevice=n,e.fromDeviceName=null===t?"Device 1":t.label,e.toDeviceName=null===n?"Device 2":n.label}function o(o){o.locale=e,o.modal={id:"linkDialog",title:e.linkDialog.title,bodyTemplate:t+"/html/link-dialog-body.html",hasSubmit:!1},o.show={loading:!0,loaded:!1,error:!1},o.submitError=null,o.selected={fromIface:null,toIface:null},n(o,null,null)}function i(e){e.show.loading=!1,e.show.loaded=!0,e.show.error=!1,e.modal.hasSubmit=!0}function r(e){e.show.loading=!1,e.show.loaded=!1,e.show.error=!0,e.modal.hasSubmit=!1}return{templateUrl:t+"/html/default-dialog.html",restrict:"C",scope:{open:"=",backdrop:"@",init:"&",fromDevice:"=",toDevice:"=",fromIfaces:"=",toIfaces:"=",selected:"=",onSubmit:"&",submitError:"="},link:function(e,t,a){o(e);var l=$(t.find("div")[0]),c={backdrop:"backdrop"in e&&"true"===e.backdrop};e.open=function(t,o){n(e,t,o),e.$$phase||e.$apply(),i(e),e.init(),l.modal(c),l.modal("show")},e.$watch("fromIfaces",function(t,n){null!==e.fromIfaces&&(e.selected.fromIface=e.fromIfaces[0])}),e.$watch("toIfaces",function(t,n){null!==e.toIfaces&&(e.selected.toIface=e.toIfaces[0])}),e.$watchGroup(["fromIfaces","toIfaces"],function(t,n){for(var o in t)null!==t[o]&&0===t[o].length&&r(e)})}}}]),angular.module("ptAnywhere").directive("updateDialog",["locale_en","baseUrl",function(e,t){function n(n){n.locale=e,n.modal={id:"modificationDialog",title:e.modificationDialog.title,bodyTemplate:t+"/html/update-dialog-body.html",hasSubmit:!0},n.submitError=null,n.device={name:"",type:null,x:0,y:0}}return{templateUrl:t+"/html/default-dialog2.html",restrict:"C",scope:{open:"=",close:"=",backdrop:"@",device:"=",interfaces:"=",onSubmit:"&",submitError:"="},link:function(e,t,o){n(e);var i=$(t.find("div")[0]),r={backdrop:"backdrop"in o&&"true"===e.backdrop};e.open=function(t){e.device=t,e.$$phase||e.$apply(),i.modal(r),i.modal("show")},e.close=function(){i.modal("hide")}}}}]);